<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Speaker VR</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- Composant custom d’explosion stable -->
    <script>
      AFRAME.registerComponent("explode-system", {
        schema: {
          distance: { type: "number", default: 0.6 },
          floatAmplitude: { type: "number", default: 0.1 }
        },

        init: function () {
          const el = this.el;
          this.parts = Array.from(el.children);

          // Sauvegarde des positions d’origine
          this.initialTransforms = this.parts.map((p) => ({
            el: p,
            pos: p.object3D.position.clone(),
            rot: p.object3D.rotation.clone()
          }));

          // Ajout de labels (sécurisé : on vérifie l'existence)
          this.parts.forEach((p) => {
            const label = document.createElement("a-text");
            label.setAttribute("value", p.id);
            label.setAttribute("align", "center");
            label.setAttribute("color", "#FFF");
            label.setAttribute("side", "double");
            label.setAttribute("scale", "0.3 0.3 0.3");
            label.setAttribute("visible", "false");
            label.object3D.position.set(0, 0.15, 0);
            p.appendChild(label);
          });

          this.exploded = false;
          this.startCycle();
        },

        startCycle: function () {
          this.toggleExplosion();
          setInterval(() => this.toggleExplosion(), 5000);
        },

        toggleExplosion: function () {
          this.exploded = !this.exploded;

          this.parts.forEach((p, i) => {
            const init = this.initialTransforms[i];

            if (this.exploded) {
              // Position éclatée
              const dx = (Math.random() - 0.5) * this.data.distance;
              const dy = (Math.random() - 0.5) * this.data.distance;
              const dz = (Math.random() - 0.5) * this.data.distance;

              const floatTo = `${init.pos.x + dx} ${init.pos.y + dy + this.data.floatAmplitude} ${init.pos.z + dz}`;

              p.setAttribute("animation__explode", {
                property: "position",
                to: `${init.pos.x + dx} ${init.pos.y + dy} ${init.pos.z + dz}`,
                dur: 1500,
                easing: "easeOutElastic"
              });

              p.setAttribute("animation__float", {
                property: "position",
                to: floatTo,
                dir: "alternate",
                loop: true,
                dur: 1800,
                easing: "easeInOutSine"
              });

              // Label visible
              p.children[0].setAttribute("visible", "true");

            } else {
              // Retour à l’état initial
              p.removeAttribute("animation__float");

              p.setAttribute("animation__implode", {
                property: "position",
                to: `${init.pos.x} ${init.pos.y} ${init.pos.z}`,
                dur: 1500,
                easing: "easeOutQuad"
              });

              // Cache label
              p.children[0].setAttribute("visible", "false");
            }
          });
        }
      });
    </script>
  </head>

  <body>
    <a-scene>

      <!-- Caméra -->
      <a-entity 
        id="camera"
        camera 
        wasd-controls 
        look-controls 
        position="0 1.6 3">
      </a-entity>

      <!-- Lumières -->
      <a-entity light="type: ambient; intensity: 0.6"></a-entity>
      <a-entity light="type: directional; intensity: 0.9" position="2 4 3"></a-entity>

      <!-- GROUPE DE L'ENCEINTE -->
      <a-entity id="enceinte" explode-system scale="0.01 0.01 0.01">

        <a-entity id="back" obj-model="obj: assets/Back.obj" position="-20.15299 4.74877 -54.67917"></a-entity>
        <a-entity id="Left" obj-model="obj: assets/Left.obj" position="-31.10108 62.18591 -69.24553"></a-entity>
        <a-entity id="Right" obj-model="obj: assets/Right.obj" position="-89.76148 21.65531 21.74075"></a-entity>
        <a-entity id="Batteries" obj-model="obj: assets/Batteries.obj" position="-78.80972 35.7123 9.96086"></a-entity>
        <a-entity id="Open" obj-model="obj: assets/Open.obj" position="-43.66647 18.64757 -44.24839"></a-entity>
        <a-entity id="Speaker" obj-model="obj: assets/Speaker.obj" position="-85.89407 11.82067 7.85191"></a-entity>
        <a-entity id="Led" obj-model="obj: assets/led.obj" position="-59.96779 77.85118 -19.66102"></a-entity>
        <a-entity id="partie-avant" obj-model="obj: assets/partie-avant.obj" position="-107.78422 29.11701 -19.38373"></a-entity>
        <a-entity id="bas" obj-model="obj: assets/bas.obj" position="-59.65366 -18.19764 -19.1577"></a-entity>

      </a-entity>

    </a-scene>
  </body>
</html>
