<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Speaker VR</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <script>
      AFRAME.registerComponent("explode-system", {
        schema: { distance: {type: "number", default: 0.3} },

        init: function () {
          const el = this.el;
          this.parts = Array.from(el.children);

          // Stockage des positions initiales
          this.initial = this.parts.map(p => ({
            el: p,
            pos: p.object3D.position.clone()
          }));

          // Ajout de labels
          this.parts.forEach(p => {
            const label = document.createElement("a-text");
            label.setAttribute("value", p.id);
            label.setAttribute("color", "white");
            label.setAttribute("align", "center");
            label.setAttribute("scale", "0.4 0.4 0.4");
            label.setAttribute("visible", "false");
            label.object3D.position.set(0, 0.15, 0);
            p.appendChild(label);
          });

          this.exploded = false;
          setInterval(() => this.toggle(), 5000);
        },

        toggle: function () {
          this.exploded = !this.exploded;

          this.parts.forEach((p, i) => {
            const orig = this.initial[i];

            if (this.exploded) {
              // Calcul position explosée aléatoire
              const dx = (Math.random() - 0.5) * this.data.distance;
              const dy = (Math.random() - 0.5) * this.data.distance;
              const dz = (Math.random() - 0.5) * this.data.distance;

              p.setAttribute("animation__explode", {
                property: "position",
                to: `${orig.pos.x + dx} ${orig.pos.y + dy} ${orig.pos.z + dz}`,
                dur: 1200,
                easing: "easeOutQuad"
              });

              p.children[0].setAttribute("visible", "true");

            } else {
              p.setAttribute("animation__implode", {
                property: "position",
                to: `${orig.pos.x} ${orig.pos.y} ${orig.pos.z}`,
                dur: 1200,
                easing: "easeOutQuad"
              });

              p.children[0].setAttribute("visible", "false");
            }
          });
        }
      });
    </script>
  </head>

  <body>
    <a-scene>

      <!-- Caméra -->
      <a-entity camera position="0 1.6 3"></a-entity>

      <!-- Lumières -->
      <a-entity light="type: ambient; intensity: 0.7"></a-entity>
      <a-entity light="type: directional; intensity: 1" position="3 5 2"></a-entity>

      <!-- GROUPE -->
      <a-entity id="enceinte" explode-system scale="0.01 0.01 0.01">

        <!-- Même si les OBJ ne se chargent pas, la scène DOIT fonctionner -->
        <a-entity id="back" obj-model="obj: assets/Back.obj" position="0 0 0"></a-entity>
        <a-entity id="Left" obj-model="obj: assets/Left.obj" position="0 0.4 0"></a-entity>
        <a-entity id="Right" obj-model="obj: assets/Right.obj" position="0 -0.4 0"></a-entity>
        <a-entity id="Speaker" obj-model="obj: assets/Speaker.obj" position="0 0 0.4"></a-entity>
        <a-entity id="Open" obj-model="obj: assets/Open.obj" position="0 0 -0.4"></a-entity>

      </a-entity>

    </a-scene>
  </body>
</html>
