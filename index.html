<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Speaker-VR</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script>
      // Composant pour créer des particules simples
      AFRAME.registerComponent('simple-particles', {
        schema: {
          enabled: {type: 'boolean', default: false},
          count: {type: 'number', default: 50}
        },
        
        init: function() {
          this.particles = [];
          
          // Créer les particules
          for (let i = 0; i < this.data.count; i++) {
            const particle = document.createElement('a-sphere');
            particle.setAttribute('radius', 0.02);
            particle.setAttribute('color', ['#ffffff', '#ffaa00', '#ff6600'][Math.floor(Math.random() * 3)]);
            particle.setAttribute('visible', false);
            this.el.appendChild(particle);
            this.particles.push({
              element: particle,
              velocity: {x: 0, y: 0, z: 0},
              life: 0
            });
          }
        },
        
        update: function() {
          if (this.data.enabled) {
            this.emit();
          } else {
            this.hide();
          }
        },
        
        emit: function() {
          this.particles.forEach(p => {
            p.element.setAttribute('visible', true);
            p.element.setAttribute('position', '0 0 0');
            
            // Vélocité aléatoire
            p.velocity = {
              x: (Math.random() - 0.5) * 2,
              y: (Math.random() - 0.5) * 2,
              z: (Math.random() - 0.5) * 2
            };
            p.life = 1.0;
            
            // Animation
            const targetPos = {
              x: p.velocity.x * 1.5,
              y: p.velocity.y * 1.5,
              z: p.velocity.z * 1.5
            };
            
            p.element.setAttribute('animation', {
              property: 'position',
              to: `${targetPos.x} ${targetPos.y} ${targetPos.z}`,
              dur: 1500,
              easing: 'easeOutQuad'
            });
            
            p.element.setAttribute('animation__opacity', {
              property: 'material.opacity',
              from: 1,
              to: 0,
              dur: 1500
            });
          });
        },
        
        hide: function() {
          this.particles.forEach(p => {
            p.element.setAttribute('visible', false);
          });
        }
      });
      
      // Composant principal d'animation
      AFRAME.registerComponent('explosion-animation', {
        init: function() {
          this.components = [
            {id: 'back', name: 'Panneau arrière', offset: {x: 0, y: 0, z: -150}},
            {id: 'Left', name: 'Côté gauche', offset: {x: -100, y: 50, z: 0}},
            {id: 'Right', name: 'Côté droit', offset: {x: 100, y: 50, z: 0}},
            {id: 'Batteries', name: 'Compartiment batteries', offset: {x: 80, y: -30, z: 50}},
            {id: 'Open', name: 'Bouton ouverture', offset: {x: -50, y: 30, z: -80}},
            {id: 'Speaker', name: 'Haut-parleur', offset: {x: 0, y: 0, z: 100}},
            {id: 'Led', name: 'LED indicateur', offset: {x: 0, y: 120, z: 0}},
            {id: 'partie-avant', name: 'Panneau avant', offset: {x: 0, y: 0, z: 150}},
            {id: 'bas', name: 'Base', offset: {x: 0, y: -80, z: 0}}
          ];
          
          this.isExploded = false;
          this.originalPositions = {};
          this.originalRotations = {};
          this.labels = {};
          
          // Attendre que les modèles soient chargés
          setTimeout(() => {
            this.setupComponents();
            // Démarrer l'animation après 5 secondes
            setTimeout(() => this.startCycle(), 5000);
          }, 500);
        },
        
        setupComponents: function() {
          // Sauvegarder les positions et rotations originales
          this.components.forEach(comp => {
            const el = document.getElementById(comp.id);
            if (el) {
              this.originalPositions[comp.id] = {
                x: el.getAttribute('position').x,
                y: el.getAttribute('position').y,
                z: el.getAttribute('position').z
              };
              
              this.originalRotations[comp.id] = {
                x: el.getAttribute('rotation').x,
                y: el.getAttribute('rotation').y,
                z: el.getAttribute('rotation').z
              };
              
              // Créer le texte explicatif
              const label = document.createElement('a-text');
              label.setAttribute('value', comp.name);
              label.setAttribute('align', 'center');
              label.setAttribute('color', '#ffffff');
              label.setAttribute('width', 3);
              label.setAttribute('position', '0 20 0');
              label.setAttribute('visible', false);
              label.setAttribute('material', 'opacity: 0');
              el.appendChild(label);
              this.labels[comp.id] = label;
            }
          });
          
          // Créer le système de particules
          const particles = document.createElement('a-entity');
          particles.setAttribute('id', 'particles');
          particles.setAttribute('simple-particles', {
            enabled: false,
            count: 80
          });
          particles.setAttribute('position', '0 0 0');
          this.el.appendChild(particles);
          this.particles = particles;
        },
        
        startCycle: function() {
          if (!this.isExploded) {
            this.explode();
          } else {
            this.reassemble();
          }
          
          // Continuer le cycle
          setTimeout(() => this.startCycle(), 5000);
        },
        
        explode: function() {
          this.isExploded = true;
          
          // Activer les particules
          this.particles.setAttribute('simple-particles', 'enabled', true);
          setTimeout(() => {
            this.particles.setAttribute('simple-particles', 'enabled', false);
          }, 100);
          
          // Animer chaque composant
          this.components.forEach((comp, index) => {
            const el = document.getElementById(comp.id);
            const label = this.labels[comp.id];
            if (el) {
              const orig = this.originalPositions[comp.id];
              const target = {
                x: orig.x + comp.offset.x,
                y: orig.y + comp.offset.y,
                z: orig.z + comp.offset.z
              };
              
              // Animation de position avec délai échelonné
              setTimeout(() => {
                el.setAttribute('animation__explode', {
                  property: 'position',
                  to: `${target.x} ${target.y} ${target.z}`,
                  dur: 1500,
                  easing: 'easeOutCubic'
                });
                
                // Rotation pour l'effet d'explosion
                const randomRot = {
                  x: this.originalRotations[comp.id].x + (Math.random() - 0.5) * 360,
                  y: this.originalRotations[comp.id].y + (Math.random() - 0.5) * 360,
                  z: this.originalRotations[comp.id].z + (Math.random() - 0.5) * 360
                };
                
                el.setAttribute('animation__rotation', {
                  property: 'rotation',
                  to: `${randomRot.x} ${randomRot.y} ${randomRot.z}`,
                  dur: 1500,
                  easing: 'easeOutCubic'
                });
                
                // Apparition du texte
                if (label) {
                  label.setAttribute('visible', true);
                  label.setAttribute('animation__fadein', {
                    property: 'material.opacity',
                    from: 0,
                    to: 1,
                    dur: 500,
                    delay: 800
                  });
                }
              }, index * 80);
            }
          });
        },
        
        reassemble: function() {
          this.isExploded = false;
          
          // Réassembler chaque composant
          this.components.forEach((comp, index) => {
            const el = document.getElementById(comp.id);
            const label = this.labels[comp.id];
            if (el) {
              const orig = this.originalPositions[comp.id];
              const origRot = this.originalRotations[comp.id];
              
              // Disparition du texte
              if (label) {
                label.setAttribute('animation__fadeout', {
                  property: 'material.opacity',
                  from: 1,
                  to: 0,
                  dur: 300
                });
                setTimeout(() => {
                  label.setAttribute('visible', false);
                }, 300);
              }
              
              // Animation de retour avec délai échelonné
              setTimeout(() => {
                el.setAttribute('animation__implode', {
                  property: 'position',
                  to: `${orig.x} ${orig.y} ${orig.z}`,
                  dur: 1500,
                  easing: 'easeInCubic'
                });
                
                // Retour à la rotation originale
                el.setAttribute('animation__rotation_back', {
                  property: 'rotation',
                  to: `${origRot.x} ${origRot.y} ${origRot.z}`,
                  dur: 1500,
                  easing: 'easeInCubic'
                });
              }, index * 80);
            }
          });
        }
      });
    </script>
  </head>
  <body>
    <a-scene>
      <!-- Camera -->
      <a-entity id="camera" camera wasd-controls look-controls position="0 1.6 3"></a-entity>
      
      <!-- Lights -->
      <a-entity light="type: ambient; intensity: 0.7; color: #ffffff"></a-entity>
      <a-entity light="type: directional; intensity: 0.8; castShadow: true" position="3 5 2"></a-entity>
      <a-entity light="type: point; intensity: 0.5; color: #ffffff" position="0 2 0"></a-entity>
      
      <!-- Sky -->
      <a-sky color="#1a1a2e"></a-sky>
      
      <!-- OBJ Models avec animation -->
      <a-entity id="enceinte" scale="0.01 0.01 0.01" position="0 0 -2" explosion-animation>
        <a-entity id="back" obj-model="obj: ./assets/Back.obj" position="-20.15299 4.74877 -54.67917" rotation="0 90 0" material="color: #ffff80"></a-entity>
        <a-entity id="Left" obj-model="obj: ./assets/Left.obj" position="-31.10108 62.18591 -69.24553" rotation="0 0 90" material="color: #8080c0"></a-entity>
        <a-entity id="Right" obj-model="obj: ./assets/Right.obj" position="-89.76148 21.65531 21.74075" rotation="0 0 -90" material="color: #8000ff"></a-entity>
        <a-entity id="Batteries" obj-model="obj: ./assets/Batteries.obj" position="-78.80972 35.7123 9.96086" rotation="-89.99963750135457 -88.58271287399606 0" material="color: #80ffff"></a-entity>
        <a-entity id="Open" obj-model="obj: ./assets/Open.obj" position="-43.66647 18.64757 -44.24839" rotation="0 90 0" material="color: #ffff00"></a-entity>
        <a-entity id="Speaker" obj-model="obj: ./assets/Speaker.obj" position="-85.89407 11.82067 7.85191" rotation="0 -90 0" material="color: #ff8000"></a-entity>
        <a-entity id="Led" obj-model="obj: ./assets/led.obj" position="-59.96779 77.85118 -19.66102" material="color: #0080c0"></a-entity>
        <a-entity id="partie-avant" obj-model="obj: ./assets/partie-avant.obj" position="-107.78422 29.11701 -19.38373" rotation="-90 90 0" material="color: #ff0000"></a-entity> 
        <a-entity id="bas" obj-model="obj: ./assets/bas.obj" position="-59.65366 -18.19764 -19.1577" rotation="0 90 0" material="side: double; color: #ff80c0"></a-entity>
      </a-entity>
      
      <!-- Instructions -->
      <a-text value="Déplacement: WASD | Regarder: Souris" position="-1.5 2.5 -3" color="#ffffff" width="3"></a-text>
    </a-scene>
  </body>
</html>
