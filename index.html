<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Speaker-VR</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- Système d’explosion -->
    <script>
      AFRAME.registerComponent("explode-system", {
        schema: {
          distance: { type: "number", default: 0.5 }, // distance d’éloignement
          floatAmplitude: { type: "number", default: 0.1 },
        },

        init: function () {
          const el = this.el;
          this.parts = Array.from(el.children);

          // Sauvegarde des positions/rotations initiales
          this.initialTransforms = this.parts.map((p) => ({
            el: p,
            pos: p.object3D.position.clone(),
            rot: p.object3D.rotation.clone(),
          }));

          // Création des labels
          this.parts.forEach((p) => {
            const label = document.createElement("a-text");
            label.setAttribute("value", p.id);
            label.setAttribute("align", "center");
            label.setAttribute("color", "#FFF");
            label.setAttribute("side", "double");
            label.setAttribute("scale", "0.5 0.5 0.5");
            label.setAttribute("visible", "false");
            label.object3D.position.set(0, 0.2, 0);
            p.appendChild(label);
          });

          this.exploded = false;
          this.toggleExplosion();
        },

        toggleExplosion: function () {
          this.exploded = !this.exploded;

          this.parts.forEach((p, i) => {
            const init = this.initialTransforms[i];

            if (this.exploded) {
              // Position éclatée (aléatoire autour du centre)
              const dx = (Math.random() - 0.5) * this.data.distance;
              const dy = (Math.random() - 0.5) * this.data.distance;
              const dz = (Math.random() - 0.5) * this.data.distance;

              p.setAttribute("animation__pos", {
                property: "position",
                to: `${init.pos.x + dx} ${init.pos.y + dy} ${init.pos.z + dz}`,
                dur: 1200,
                easing: "easeOutQuad",
              });

              // Flottement
              p.setAttribute("animation__float", {
                property: "position",
                dir: "alternate",
                dur: 1500,
                loop: true,
                easing: "easeInOutSine",
                to: `${init.pos.x + dx} ${init.pos.y + dy + this.data.floatAmplitude} ${init.pos.z + dz}`,
              });

              // Affichage texte
              p.children[0].setAttribute("visible", "true");

            } else {
              p.removeAttribute("animation__float");

              p.setAttribute("animation__pos", {
                property: "position",
                to: `${init.pos.x} ${init.pos.y} ${init.pos.z}`,
                dur: 1200,
                easing: "easeOutQuad",
              });

              p.children[0].setAttribute("visible", "false");
            }
          });

          // Reboucle après 5 secondes
          setTimeout(() => this.toggleExplosion(), 5000);
        },
      });
    </script>

    <!-- Particules -->
    <script src="https://cdn.jsdelivr.net/gh/IdeaSpaceVR/aframe-particle-system-component/dist/aframe-particle-system-component.min.js"></script>
  </head>

  <body>
    <a-scene>

      <!-- Caméra -->
      <a-entity id="camera" camera wasd-controls look-controls position="0 1.6 3"></a-entity>

      <!-- Lumières -->
      <a-entity light="type: ambient; intensity: 0.7"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="3 5 2"></a-entity>

      <!-- Effet de particules (explosion) -->
      <a-entity
        particle-system="preset: dust; particleCount: 500; size: 2; color: #ffaa00"
        position="0 1 0">
      </a-entity>

      <!-- OBJ regroupés dans "enceinte" -->
      <a-entity id="enceinte" explode-system scale="0.01 0.01 0.01">

        <a-entity id="back" obj-model="obj: ./assets/Back.obj" position="-20.15299 4.74877 -54.67917"></a-entity>
        <a-entity id="Left" obj-model="obj: ./assets/Left.obj" position="-31.10108 62.18591 -69.24553"></a-entity>
        <a-entity id="Right" obj-model="obj: ./assets/Right.obj" position="-89.76148 21.65531 21.74075"></a-entity>
        <a-entity id="Batteries" obj-model="obj: ./assets/Batteries.obj" position="-78.80972 35.7123 9.96086"></a-entity>
        <a-entity id="Open" obj-model="obj: ./assets/Open.obj" position="-43.66647 18.64757 -44.24839"></a-entity>
        <a-entity id="Speaker" obj-model="obj: ./assets/Speaker.obj" position="-85.89407 11.82067 7.85191"></a-entity>
        <a-entity id="Led" obj-model="obj: ./assets/led.obj" position="-59.96779 77.85118 -19.66102"></a-entity>
        <a-entity id="partie-avant" obj-model="obj: ./assets/partie-avant.obj" position="-107.78422 29.11701 -19.38373"></a-entity>
        <a-entity id="bas" obj-model="obj: ./assets/bas.obj" position="-59.65366 -18.19764 -19.1577"></a-entity>

      </a-entity>

    </a-scene>
  </body>
</html>
