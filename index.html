<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Speaker-VR</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- Système d’explosion -->
    <script>
      AFRAME.registerComponent("explode-system", {
        schema: {
          distance: { type: "number", default: 0.5 }, // distance d’éloignement
          floatAmplitude: { type: "number", default: 0.1 },
          explosionDelay: { type: "number", default: 5000 }, // délai avant première explosion (5s)
          reformationDelay: { type: "number", default: 5000 }, // délai avant reformation (5s)
        },

        init: function () {
          const el = this.el;
          this.parts = Array.from(el.children);

          // Sauvegarde des positions/rotations initiales
          this.initialTransforms = this.parts.map((p) => ({
            el: p,
            pos: p.object3D.position.clone(),
            rot: p.object3D.rotation.clone(),
          }));

          // Création des labels avec descriptions explicatives (personnalisez-les si besoin)
          const descriptions = {
            back: "Partie arrière : Protège les composants internes et améliore la résonance.",
            Left: "Côté gauche : Contribue à la structure et à l'esthétique de l'enceinte.",
            Right: "Côté droit : Symétrique au côté gauche pour un équilibre acoustique.",
            Batteries: "Batteries : Fournissent l'énergie pour un fonctionnement sans fil.",
            Open: "Ouverture : Permet l'accès aux composants internes pour la maintenance.",
            Speaker: "Haut-parleur : Convertit les signaux électriques en ondes sonores.",
            Led: "LED : Indicateur lumineux pour l'état de l'appareil.",
            "partie-avant": "Partie avant : Diffuse le son et protège le haut-parleur.",
            bas: "Partie basse : Base stable pour l'enceinte.",
          };

          this.parts.forEach((p) => {
            const label = document.createElement("a-text");
            label.setAttribute("value", descriptions[p.id] || p.id); // Utilise la description ou l'ID par défaut
            label.setAttribute("align", "center");
            label.setAttribute("color", "#FFF");
            label.setAttribute("side", "double");
            label.setAttribute("scale", "0.5 0.5 0.5");
            label.setAttribute("visible", "false");
            label.object3D.position.set(0, 0.2, 0); // Position relative au composant
            p.appendChild(label);
          });

          this.exploded = false;

          // Démarre le cycle après le délai initial (enceinte assemblée au départ)
          setTimeout(() => this.toggleExplosion(), this.data.explosionDelay);
        },

        toggleExplosion: function () {
          this.exploded = !this.exploded;

          // Gestion des particules : visibles seulement pendant l'explosion
          const particles = document.querySelector('[particle-system]');
          if (particles) {
            particles.setAttribute('visible', this.exploded);
          }

          this.parts.forEach((p, i) => {
            const init = this.initialTransforms[i];

            // Supprime les animations existantes pour éviter les conflits
            p.removeAttribute("animation__pos");
            p.removeAttribute("animation__float");

            if (this.exploded) {
              // Position éclatée (aléatoire autour du centre)
              const dx = (Math.random() - 0.5) * this.data.distance;
              const dy = (Math.random() - 0.5) * this.data.distance;
              const dz = (Math.random() - 0.5) * this.data.distance;

              p.setAttribute("animation__pos", {
                property: "position",
                to: `${init.pos.x + dx} ${init.pos.y + dy} ${init.pos.z + dz}`,
                dur: 1200,
                easing: "easeOutQuad",
              });

              // Flottement (seulement pendant l'explosion)
              p.setAttribute("animation__float", {
                property: "position",
                dir: "alternate",
                dur: 1500,
                loop: true,
                easing: "easeInOutSine",
                to: `${init.pos.x + dx} ${init.pos.y + dy + this.data.floatAmplitude} ${init.pos.z + dz}`,
              });

              // Affichage du texte explicatif
              p.children[0].setAttribute("visible", "true");

            } else {
              // Retour à la position initiale
              p.setAttribute("animation__pos", {
                property: "position",
                to: `${init.pos.x} ${init.pos.y} ${init.pos.z}`,
                dur: 1200,
                easing: "easeOutQuad",
              });

              // Masquage du texte
              p.children[0].setAttribute("visible", "false");
            }
          });

          // Reboucle : si explosé, attendre reformationDelay pour se reformer ; sinon, attendre explosionDelay pour exploser
          const nextDelay = this.exploded ? this.data.reformationDelay : this.data.explosionDelay;
          setTimeout(() => this.toggleExplosion(), nextDelay);
        },
      });
    </script>

    <!-- Particules -->
    <script src="https://cdn.jsdelivr.net/gh/IdeaSpaceVR/aframe-particle-system-component/dist/aframe-particle-system-component.min.js"></script>
  </head>

  <body>
    <a-scene>
      <!-- Caméra -->
      <a-entity id="camera" camera wasd-controls look-controls position="0 1.6 3"></a-entity>

      <!-- Lumières -->
      <a-entity light="type: ambient; intensity: 0.7"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="3 5 2"></a-entity>

      <!-- Effet de particules (explosion) - Invisible par défaut -->
      <a-entity
        particle-system="preset: dust; particleCount: 500; size: 2; color: #ffaa00"
        position="0 1 0"
        visible="false">
      </a-entity>

      <!-- OBJ regroupés dans "enceinte" -->
      <a-entity id="enceinte" explode-system scale="0.01 0.01 0.01">
        <a-entity id="back" obj-model="obj: ./assets/Back.obj" position="-20.15299 4.74877 -54.67917"></a-entity>
        <a-entity id="Left" obj-model="obj: ./assets/Left.obj" position="-31.10108 62.18591 -69.24553"></a-entity>
        <a-entity id="Right" obj-model="obj: ./assets/Right.obj" position="-89.76148 21.65531 21.74075"></a-entity>
        <a-entity id="Batteries" obj-model="obj: ./assets/Batteries.obj" position="-78.80972 35.7123 9.96086"></a-entity>
        <a-entity id="Open" obj-model="obj: ./assets/Open.obj" position="-43.66647 18.64757 -44.24839"></a-entity>
        <a-entity id="Speaker" obj-model="obj: ./assets/Speaker.obj" position="-85.89407 11.82067 7.85191"></a-entity>
        <a-entity id="Led" obj-model="obj: ./assets/led.obj" position="-59.96779 77.85118 -19.66102"></a-entity>
        <a-entity id="partie-avant" obj-model="obj: ./assets/partie-avant.obj" position="-107.78422 29.11701 -19.38373"></a-entity>
        <a-entity id="bas" obj-model="obj: ./assets/bas.obj" position="-59.65366 -18.19764 -19.1577"></a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>
