<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Speaker-VR</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- Camera -->
      <a-entity id="camera" camera wasd-controls look-controls position="0 1.6 3"></a-entity>
      
      <!-- Lights -->
      <a-entity light="type: ambient; intensity: 0.7; color: #ffffff"></a-entity>
      <a-entity light="type: directional; intensity: 0.8; castShadow: true" position="3 5 2"></a-entity>
      <a-entity light="type: point; intensity: 0.5; color: #ffffff" position="0 2 0"></a-entity>
      
      <!-- Sky -->
      <a-sky color="#1a1a2e"></a-sky>
      
      <!-- OBJ Models avec animation -->
      <a-entity id="enceinte" scale="0.01 0.01 0.01" position="0 0 -2">
        <a-entity id="back" obj-model="obj: ./assets/Back.obj" position="-20.15299 4.74877 -54.67917" rotation="0 90 0" material="color: #ffff80"></a-entity>
        <a-entity id="Left" obj-model="obj: ./assets/Left.obj" position="-31.10108 62.18591 -69.24553" rotation="0 0 90" material="color: #8080c0"></a-entity>
        <a-entity id="Right" obj-model="obj: ./assets/Right.obj" position="-89.76148 21.65531 21.74075" rotation="0 0 -90" material="color: #8000ff"></a-entity>
        <a-entity id="Batteries" obj-model="obj: ./assets/Batteries.obj" position="-78.80972 35.7123 9.96086" rotation="-89.99963750135457 -88.58271287399606 0" material="color: #80ffff"></a-entity>
        <a-entity id="Open" obj-model="obj: ./assets/Open.obj" position="-43.66647 18.64757 -44.24839" rotation="0 90 0" material="color: #ffff00"></a-entity>
        <a-entity id="Speaker" obj-model="obj: ./assets/Speaker.obj" position="-85.89407 11.82067 7.85191" rotation="0 -90 0" material="color: #ff8000"></a-entity>
        <a-entity id="Led" obj-model="obj: ./assets/led.obj" position="-59.96779 77.85118 -19.66102" material="color: #0080c0"></a-entity>
        <a-entity id="partie-avant" obj-model="obj: ./assets/partie-avant.obj" position="-107.78422 29.11701 -19.38373" rotation="-90 90 0" material="color: #ff0000"></a-entity> 
        <a-entity id="bas" obj-model="obj: ./assets/bas.obj" position="-59.65366 -18.19764 -19.1577" rotation="0 90 0" material="side: double; color: #ff80c0"></a-entity>
      </a-entity>
      
      <!-- Particules -->
      <a-entity id="particles-container" position="0 0 -2"></a-entity>
      
      <!-- Instructions -->
      <a-text value="Déplacement: WASD | Regarder: Souris" position="-1.5 2.5 -3" color="#ffffff" width="3"></a-text>
    </a-scene>

    <script>
      // Attendre que A-Frame soit complètement chargé
      document.addEventListener('DOMContentLoaded', function() {
        const enceinte = document.getElementById('enceinte');
        const particlesContainer = document.getElementById('particles-container');
        
        const components = [
          {id: 'back', name: 'Panneau arrière', offset: {x: 0, y: 0, z: -50}},
          {id: 'Left', name: 'Côté gauche', offset: {x: -40, y: 20, z: 0}},
          {id: 'Right', name: 'Côté droit', offset: {x: 40, y: 20, z: 0}},
          {id: 'Batteries', name: 'Compartiment batteries', offset: {x: 30, y: -10, z: 20}},
          {id: 'Open', name: 'Bouton ouverture', offset: {x: -20, y: 10, z: -30}},
          {id: 'Speaker', name: 'Haut-parleur', offset: {x: 0, y: 0, z: 40}},
          {id: 'Led', name: 'LED indicateur', offset: {x: 0, y: 50, z: 0}},
          {id: 'partie-avant', name: 'Panneau avant', offset: {x: 0, y: 0, z: 60}},
          {id: 'bas', name: 'Base', offset: {x: 0, y: -30, z: 0}}
        ];
        
        let isExploded = false;
        const originalData = {};
        const labels = {};
        const particles = [];
        
        // Créer les particules
        function createParticles() {
          const colors = ['#ffffff', '#ffaa00', '#ff6600'];
          for (let i = 0; i < 100; i++) {
            const particle = document.createElement('a-sphere');
            particle.setAttribute('radius', 0.015);
            particle.setAttribute('color', colors[Math.floor(Math.random() * colors.length)]);
            particle.setAttribute('material', 'opacity: 0');
            particle.setAttribute('visible', false);
            particlesContainer.appendChild(particle);
            particles.push(particle);
          }
          
          // Créer la sphère d'explosion centrale
          const explosionSphere = document.createElement('a-sphere');
          explosionSphere.setAttribute('id', 'explosion-sphere');
          explosionSphere.setAttribute('radius', 0.1);
          explosionSphere.setAttribute('color', '#ffaa00');
          explosionSphere.setAttribute('material', 'opacity: 0; emissive: #ff6600; emissiveIntensity: 2');
          explosionSphere.setAttribute('visible', false);
          particlesContainer.appendChild(explosionSphere);
        }
        
        // Initialisation
        function init() {
          createParticles();
          
          // Sauvegarder les données originales et créer les labels
          components.forEach(comp => {
            const el = document.getElementById(comp.id);
            if (el) {
              const pos = el.getAttribute('position');
              const rot = el.getAttribute('rotation');
              
              originalData[comp.id] = {
                position: {x: pos.x, y: pos.y, z: pos.z},
                rotation: {x: rot.x, y: rot.y, z: rot.z}
              };
              
              // Créer le label
              const label = document.createElement('a-text');
              label.setAttribute('value', comp.name);
              label.setAttribute('align', 'center');
              label.setAttribute('color', '#ffffff');
              label.setAttribute('width', 3);
              label.setAttribute('position', '0 0.2 0');
              label.setAttribute('visible', false);
              label.setAttribute('material', 'opacity: 0');
              el.appendChild(label);
              labels[comp.id] = label;
            }
          });
          
          // Démarrer le cycle
          setTimeout(() => startCycle(), 5000);
        }
        
        // Émettre les particules
        function emitParticles() {
          const explosionSphere = document.getElementById('explosion-sphere');
          
          // Animation de la sphère d'explosion centrale
          explosionSphere.setAttribute('visible', true);
          explosionSphere.setAttribute('material', 'opacity: 1; emissive: #ff6600; emissiveIntensity: 3');
          explosionSphere.setAttribute('radius', 0.1);
          
          // Expansion rapide
          explosionSphere.setAttribute('animation', {
            property: 'radius',
            from: 0.1,
            to: 0.8,
            dur: 400,
            easing: 'easeOutQuad'
          });
          
          explosionSphere.setAttribute('animation__fade', {
            property: 'material.opacity',
            from: 1,
            to: 0,
            dur: 400,
            easing: 'easeOutQuad'
          });
          
          setTimeout(() => {
            explosionSphere.setAttribute('visible', false);
          }, 400);
          
          // Particules qui s'échappent
          particles.forEach((particle, i) => {
            setTimeout(() => {
              const angle = (i / particles.length) * Math.PI * 2;
              const elevation = (Math.random() - 0.5) * Math.PI;
              const radius = 0.8 + Math.random() * 0.7;
              
              particle.setAttribute('visible', true);
              particle.setAttribute('position', '0 0 0');
              particle.setAttribute('material', 'opacity: 1');
              
              const targetX = Math.cos(angle) * Math.cos(elevation) * radius;
              const targetY = Math.sin(elevation) * radius;
              const targetZ = Math.sin(angle) * Math.cos(elevation) * radius;
              
              particle.setAttribute('animation', {
                property: 'position',
                to: `${targetX} ${targetY} ${targetZ}`,
                dur: 1500,
                easing: 'easeOutCubic'
              });
              
              particle.setAttribute('animation__fade', {
                property: 'material.opacity',
                from: 1,
                to: 0,
                dur: 1500,
                easing: 'easeInQuad'
              });
              
              setTimeout(() => {
                particle.setAttribute('visible', false);
              }, 1500);
            }, i * 8);
          });
        }
        
        // Explosion
        function explode() {
          isExploded = true;
          emitParticles();
          
          components.forEach((comp, index) => {
            const el = document.getElementById(comp.id);
            const label = labels[comp.id];
            
            if (el) {
              setTimeout(() => {
                const orig = originalData[comp.id].position;
                const targetPos = {
                  x: orig.x + comp.offset.x,
                  y: orig.y + comp.offset.y,
                  z: orig.z + comp.offset.z
                };
                
                const origRot = originalData[comp.id].rotation;
                const targetRot = {
                  x: origRot.x + (Math.random() - 0.5) * 90,
                  y: origRot.y + (Math.random() - 0.5) * 90,
                  z: origRot.z + (Math.random() - 0.5) * 90
                };
                
                el.setAttribute('animation__pos', {
                  property: 'position',
                  to: `${targetPos.x} ${targetPos.y} ${targetPos.z}`,
                  dur: 1500,
                  easing: 'easeOutCubic'
                });
                
                el.setAttribute('animation__rot', {
                  property: 'rotation',
                  to: `${targetRot.x} ${targetRot.y} ${targetRot.z}`,
                  dur: 1500,
                  easing: 'easeOutCubic'
                });
                
                if (label) {
                  setTimeout(() => {
                    label.setAttribute('visible', true);
                    label.setAttribute('animation', {
                      property: 'material.opacity',
                      from: 0,
                      to: 1,
                      dur: 500
                    });
                  }, 800);
                }
              }, index * 80);
            }
          });
        }
        
        // Reassemblage
        function reassemble() {
          isExploded = false;
          
          components.forEach((comp, index) => {
            const el = document.getElementById(comp.id);
            const label = labels[comp.id];
            
            if (el) {
              if (label) {
                label.setAttribute('animation', {
                  property: 'material.opacity',
                  from: 1,
                  to: 0,
                  dur: 300
                });
                setTimeout(() => {
                  label.setAttribute('visible', false);
                }, 300);
              }
              
              setTimeout(() => {
                const orig = originalData[comp.id].position;
                const origRot = originalData[comp.id].rotation;
                
                el.setAttribute('animation__pos', {
                  property: 'position',
                  to: `${orig.x} ${orig.y} ${orig.z}`,
                  dur: 1500,
                  easing: 'easeInCubic'
                });
                
                el.setAttribute('animation__rot', {
                  property: 'rotation',
                  to: `${origRot.x} ${origRot.y} ${origRot.z}`,
                  dur: 1500,
                  easing: 'easeInCubic'
                });
              }, index * 80);
            }
          });
        }
        
        // Cycle principal
        function startCycle() {
          if (!isExploded) {
            explode();
          } else {
            reassemble();
          }
          setTimeout(() => startCycle(), 5000);
        }
        
        // Attendre le chargement de la scène
        const scene = document.querySelector('a-scene');
        if (scene.hasLoaded) {
          init();
        } else {
          scene.addEventListener('loaded', init);
        }
      });
    </script>
  </body>
</html>
